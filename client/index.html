<!doctype html>  
<html lang="en">

<head>

</head>

<body>
	<div id="app">
		<div id="ui-top">
			<div>Team {{teamId}}</div>
		</div>
	</div>
	<canvas id="canvas"></canvas>
</div>

	<div id="game">
		<canvas id="canvas"></canvas>
	</div>

	<script src="/socket.io/socket.io.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script>
		var socket = io();
	
		var map;
		var units;
		var teams = {};
		var teamId;
	
		var tileSize = 16;
		var canvas = document.getElementById("canvas");
		var c = canvas.getContext("2d");
	
		socket.on("mapUpdate", function(data){
			map = data.map;
			teams = data.teams;
	socket.on("faction", function(data){
		faction = data.factionId;
	});
	
			canvas.width = map.width * tileSize;
			canvas.height = map.height * tileSize;
	
			drawMap();
		});
	
		socket.on("teamId", function(data){
			teamId = data.teamId;
			app.teamId = teamId;
		});
	
		function moveUnit(unitId, to){
			socket.emit("moveUnit", {
				unitId : unitId,
				to : to
			});
		}
	
		function attackUnit(attackerId, defenderId){
			socket.emit("attackUnit", {
				attackerId : attackerId,
				defenderId : defenderId,
			});
		}
	
		function buyUnit(position){
			socket.emit("buyUnit", {
				position : position,
			});
		}

		var app = new Vue({
		  	el: '#app',
		  	data: {
		    	teamId : "none"
		  	}
		})
	
		var selectedUnit = null;
		var selectedPosition = null;
	
		canvas.addEventListener("click", handleClick);
		
		//document.addEventListener("keydown", handleKeydown);
		
	// 	function handleKeydown(e){
	// 		if (selectedUnit == null){
	// 			return false;
	// 		}
	// 		if (e.keyCode == 37){
	// 			//left
	// 			if (selectedUnitId != null){
	// 				socket.emit("moveUnit", {
	// 					unitId : selectedUnit.id,
	// 					to : {x : selectedUnit.position.x - 1, y : selectedUnit.position.y}
	// 				});
	// 			}
	// 		}
	// 		else if (e.keyCode == 38){
	// 			//up
	// 			if (selectedUnitId != null){
	// 				socket.emit("moveUnit", {
	// 					unitId : selectedUnit.id,
	// 					to : {x : selectedUnit.position.x, y : selectedUnit.position.y - 1}
	// 				});
	// 			}
	// 		}
	// 		else if (e.keyCode == 39){
	// 			//right
	// 			if (selectedUnitId != null){
	// 				socket.emit("moveUnit", {
	// 					unitId : selectedUnit.id,
	// 					to : {x : selectedUnit.position.x + 1, y : selectedUnit.position.y}
	// 				});
	// 			}
	// 		}
	// 	app.selectedTile = {x : x, y : y};
	// }
		function handleClick(e){
			var x = Math.floor((e.clientX - canvas.offsetLeft) / tileSize);
			var y = Math.floor((e.clientY - canvas.offsetTop) / tileSize);
	
			var clickedUnit = map.unitMap[x][y].unit;
			var clickedPosition = {x : x, y : y};
	
			//if we have a selected unit
			if (selectedUnit != null){
				//and we clicked an empty tile
				if (clickedUnit == null){
					//then move
					moveUnit(selectedUnit.id, clickedPosition);
				}
				//tile is occupied
				else{
					//the unit is one of ours
					if (clickedUnit.teamId == teamId){
						//select it
						selectedUnit = clickedUnit;
					}
					//it is an enemy
					else{
						attackUnit(selectedUnit.id, clickedUnit.id);
					}
				}
			}
			else{
				//we have no unit selected so we select that unit
				selectedUnit = clickedUnit;
			}
		}
		
		//drawing
		function drawMap(){
			//clear map
			c.clearRect(0, 0, canvas.width, canvas.height);
		
			c.fillRect(0, 0, map.width * tileSize, map.height * tileSize);
			for (var x = 0; x < map.width; x++){
				for (var y = 0; y < map.height; y++){
					//draw black border
					c.fillStyle = "#000000";
					c.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
					//draw green inside
					c.fillStyle = "#2ECC71";
					c.fillRect(x * tileSize + 1, y * tileSize + 1, tileSize - 2, tileSize - 2);
				}
			}
		
		
			for (var i in map.units){
				var unit = map.units[i];
	
				//top left of unit
				var x = unit.position.x * tileSize;
				var y = unit.position.y * tileSize;
	
				if (unit.moving){
					//show movement progress
					if (unit.position.x > unit.destination.x){
						x -= Math.floor(tileSize * unit.progress / 100);
					}
					else if (unit.position.x < unit.destination.x){
						x += Math.floor(tileSize * unit.progress / 100);
					}
			
					if (unit.position.y > unit.destination.y){
						y -= Math.floor(tileSize * unit.progress / 100);
					}
					else if (unit.position.y < unit.destination.y){
						y += Math.floor(tileSize * unit.progress / 100);
					}
				}
				
				//if unit is selected draw border around it
				if (selectedUnit != null){
					if (unit.id == selectedUnit.id){
						c.fillStyle = "#FFFFFF";
						c.fillRect(x, y, tileSize, tileSize);
					}
				}
				
				//draw unit
				c.fillStyle = teams[unit.teamId].color;
				c.fillRect(x + 1, y + 1, tileSize - 2, tileSize - 2);
				
				//draw border around health bar
				c.fillStyle = "#000000";
				c.fillRect(x - Math.floor(tileSize * .4), y - Math.floor(tileSize * .6), Math.floor(tileSize * 1.8), Math.floor(tileSize * .4));
				
				//draw health bar
				c.fillStyle = "#FF0000";
				c.fillRect(
					x - Math.floor(tileSize * .4) + 1, 
					y - Math.floor(tileSize * .6) + 1, 
					Math.floor((Math.floor(tileSize * 1.8) * unit.health / unit.maxHealth)) - 2, 
					Math.floor(tileSize * .4) - 2
					);
			}
		}
	</script>

</body>

</html>  
