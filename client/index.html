<!doctype html>  
<html lang="en">

<head>

</head>

<body id="body">

<div id="game">
	<div id="ui">
		<div id="faction">Team {{faction}}</div>
		Points : {{points}}
		Selected Tile : {{selectedTile}}
		<button onclick="buildUnit()">Build Unit</button>
	</div>
=	<canvas id="canvas"></canvas>
</div>

<script src="/socket.io/socket.io.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

<script>
	var socket = io();
	var map;
	var units;
	var factions = {};
	var faction;
	var tileSize = 16;
	var canvas = document.getElementById("canvas");
	var c = canvas.getContext("2d");

	var app = new Vue({
	  	el: '#ui',
	  	data: {
	    	points: 0,
	    	selectedTile : "none",
	    	faction : "none",
	  	}
	})
	
	canvas.width = 20 * tileSize;
	canvas.height = 20 * tileSize;
	
	socket.on("mapUpdate", function(data){
		console.log("Recieved map update.");
		map = data.map;
		factions = data.factions;
		drawMap();
		if (faction){
			app.points = factions[faction].points;
			app.faction = faction;
			document.getElementById("faction").style.backgroundColor = factions[faction].color; 
		}
	});
	
	socket.on("faction", function(data){
		faction = data.factionId;
	});
	
	var selectedUnitId = null;
	
	canvas.addEventListener("click", handleClick);
	
	document.addEventListener("keydown", handleKeydown);

	function handleClick(e){
		var x = Math.floor((e.clientX - canvas.offsetLeft) / tileSize);
		var y = Math.floor((e.clientY - canvas.offsetTop) / tileSize);
		// var unit = map.getUnitAt({x : x, y : y});
		var tile = map.unitMap[x][y];
		if (tile.unit != null){
			if (tile.unit.teamId != faction && selectedUnitId != null && tile.unit.teamId != selectedUnitId){
				socket.emit("attackUnit", {
					attackerId : selectedUnitId,
					defenderId : tile.unit.id
				});
			}
			else if (tile.unit.teamId == faction){
				selectedUnitId = tile.unit.id;
			}
			else{
				selectedUnitId = tile.unit.id;
			}
		}
		else {
			if (tile.movingTo == null && selectedUnitId != null){
				socket.emit("moveUnit", {
					unitId : selectedUnitId,
					to : {x : x, y : y}
				});
			}
		}
		app.selectedTile = {x : x, y : y};
	}
	
	//Game

	function drawMap(){
		c.clearRect(0, 0, canvas.width, canvas.height);
	
		//temporary drawing of tiles
		c.fillRect(0, 0, map.width * tileSize, map.height * tileSize);
		for (var x = 0; x < map.width; x++){
			for (var y = 0; y < map.height; y++){
				c.fillStyle = "#000000";
				c.fillRect(x * tileSize, y * tileSize, tileSize, tileSize);
				c.fillStyle = "#2ECC71";
				c.fillRect(x * tileSize + 1, y * tileSize + 1, tileSize - 2, tileSize - 2);
			}
		}
	
	
		for (var i in map.units){
			var unit = map.units[i];
			var x = unit.position.x * tileSize;
			var y = unit.position.y * tileSize;
			if (unit.moving){
				if (unit.position.x > unit.destination.x){
					x -= Math.floor(tileSize * unit.progress / 100);
				}
				else if (unit.position.x < unit.destination.x){
					x += Math.floor(tileSize * unit.progress / 100);
				}
		
				if (unit.position.y > unit.destination.y){
					y -= Math.floor(tileSize * unit.progress / 100);
				}
				else if (unit.position.y < unit.destination.y){
					y += Math.floor(tileSize * unit.progress / 100);
				}
			}
			
			//if unit is selected draw border around it
			if (unit.id == selectedUnitId){
				c.fillStyle = "#FFFFFF";
				c.fillRect(x, y, tileSize, tileSize);
			}
			
			//draw unit
			c.fillStyle = factions[unit.teamId].color;
			c.fillRect(x + 1, y + 1, tileSize - 2, tileSize - 2);
			
			//draw border around health bar
			c.fillStyle = "#000000";
			c.fillRect(x - Math.floor(tileSize * .4), y - Math.floor(tileSize * .6), Math.floor(tileSize * 1.8), Math.floor(tileSize * .4));
			
			//draw health bar
			c.fillStyle = "#FF0000";
			c.fillRect(x - Math.floor(tileSize * .4) + 1, y - Math.floor(tileSize * .6) + 1, Math.floor((Math.floor(tileSize * 1.8) * unit.health / unit.maxHealth)) - 2, Math.floor(tileSize * .4) - 2);
		}
	}

	function buildUnit(){
		socket.emit("buyUnit", {
			position : app.selectedTile,
		});
	}
</script>

</body>

</html>  
