<!doctype html>  
<html lang="en">

<head>

</head>

<body>

<canvas id="canvas" width="1000" height="1000"></canvas>

<script src="/socket.io/socket.io.js"></script>

<script>

var socket = io();

var map;
var units;
var factions;
var tileSize = 32;

var canvas = document.getElementById("canvas");
var c = canvas.getContext("2d");
	
var unit;

canvas.width = 20 * tileSize;
canvas.height = 20 * tileSize;

socket.on("mapUpdate", function(data){
	console.log("Recieved map update.");
	map = data.map;
	factions = data.factions;
	drawMap();
});

var selectedUnitId = null;

canvas.addEventListener("click", handleClick);

document.addEventListener("keydown", function(e){
	console.log("key pressed " + e.keyCode);
	if (e.keyCode == 37){
		//left
		if (selectedUnitId != null){
			console.log("Yes!");
			socket.emit("moveUnit", {
				unitId : selectedUnitId,
				to : {x : selectedUnit.position.x - 1, y : selectedUnit.position.y}
			});
		}
	}
	else if (e.keyCode == 38){
		//up
		if (selectedUnit != null){
			socket.emit("moveUnit", {
				unitId : selectedUnitId,
				to : {x : selectedUnit.position.x, y : selectedUnit.position.y + 1}
			});
		}
	}
	else if (e.keyCode == 39){
		//right
		if (selectedUnit != null){
			socket.emit("moveUnit", {
				unitId : selectedUnitId,
				to : {x : selectedUnit.position.x + 1, y : selectedUnit.position.y}
			});
		}
	}
	else if (e.keyCode == 40){
		//down
		if (selectedUnit != null){
			socket.emit("moveUnit", {
				unitId : selectedUnitId,
				to : {x : selectedUnit.position.x, y : selectedUnit.position.y - 1}
			});
		}
	}
});

function handleClick(e){
	var x = Math.floor((e.clientX - canvas.offsetLeft) / tileSize);
	var y = Math.floor((e.clientY - canvas.offsetTop) / tileSize);

	// var unit = map.getUnitAt({x : x, y : y});
	var tile = map.unitMap[x][y];

	if (tile.unit != null){
		selectedUnitId = tile.unit.id;
	}
	else {
		if (tile.movingTo == null && selectedUnitId != null){
			socket.emit("moveUnit", {
				unitId : selectedUnitId,
				to : {x : x, y : y}
			});
			selectedUnit = null;
		}
	}
}

function drawMap(){
	c.clearRect(0, 0, canvas.width, canvas.height);

	//temporary drawing of tiles
	c.fillStyle = "#2ECC71";
	c.fillRect(0, 0, map.width * tileSize, map.height * tileSize);

	for (var i in map.units){
		var unit = map.units[i];
		c.fillStyle = factions[unit.teamId].color;

		var x = unit.position.x * tileSize;
		var y = unit.position.y * tileSize;

		if (unit.moving){
			if (unit.position.x > unit.destination.x){
				x -= Math.floor(tileSize * unit.progress / 100);
			}
			else if (unit.position.x < unit.destination.x){
				x += Math.floor(tileSize * unit.progress / 100);
			}
	
			if (unit.position.y > unit.destination.y){
				y -= Math.floor(tileSize * unit.progress / 100);
			}
			else if (unit.position.y < unit.destination.y){
				y += Math.floor(tileSize * unit.progress / 100);
			}
		}

		c.fillRect(x, y, tileSize, tileSize);
	}
}

</script>

</body>

</html>  
